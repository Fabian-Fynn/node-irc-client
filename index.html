<link rel="stylesheet" href="main.css"/>

<h1>Awesome IRC-Client</h1>
<div class="conversations">
  <div id="msgs">
    <div id="note"> Scroll to see new messages</div>
  </div>

  <textarea id="text" type="text" autofocus> </textarea>
  <button id="send">Send</button>
</div>
<div id="list">
  <h2>Guests</h2>
  <ul></ul>
</div>

<script>
  var $ = require('jQuery');
  var irc = require("irc");
  var me = 'ItsaMe';
  var channel = '#schnitzelwirt';
  var client = new irc.Client('chat.freenode.org', me, {
    channels: [channel]
  });
  var guests = require('./guests');
  var msg = require('./message');
  var messages = [];
  var scroll = false;

  (function(){
    $('#note').hide();
    $('#text').on('keyup', function(event) {
      if(event.which == 13) { //ignore if ''
        say();
      }
    });

    $('#send').click(function (){
      say();
    });

    $('#msgs').bind('scroll', checkScroll);
  })();

  client.addListener('message', function (from, to, message) {
    var message = new msg(from, to, message);
    messages.push(message);
    printMessage();
    if(scroll){
      $('#note').show();
    }
    else{
      scrollDown();
    }
  });

  client.on('names#schnitzelwirt', function(nicks) {
    for(var key in nicks) {
      guests.list.push(key);
    }
    guests.printList();
  });

  client.on('join#schnitzelwirt', function(nick) {
    if(nick != me)
      guests.list.push(nick);
    guests.printList();
  });

  client.on('quit', function(nick) {
    guests.list.splice(guests.list.indexOf(nick),1);
    guests.printList();
  });

  client.addListener('error', function(message) {
    console.log('error: ', message);
  });

  function printMessage() {
    $('#msgs').append('<div>' + messages[messages.length - 1].from + ': ' +
      messages[messages.length - 1].message + '</div>');
  }

  function say() {
    var text = $('#text').val();
    if( text != '' ) {
      client.say(channel, text);
      var message = new msg(me, channel, text);
      messages.push(message);
      $('#text').val('');
      printMessage();
    }
    scrollDown();
    $('#text').focus();
  };

  function scrollDown() {
    $('#msgs').scrollTop($('#msgs').height());
    $('#note').hide();
  }

  function checkScroll(e)
  {
    var elem = $(e.currentTarget);
    if (elem[0].scrollHeight - elem.scrollTop() <= elem.outerHeight())
    {
      scroll = false;
      $('#note').hide();
    }
    else
    {
      scroll = true;
    }

  }
</script>